// INITIALIZE EMAILJS
emailjs.init("n84eVGeczJMPu9O6U");

// Hide loading screen after 2s
setTimeout(() => document.getElementById("loadingScreen").style.display = "none", 2000);

// DYNAMIC GALLERY
const galleryContainer = document.querySelector(".gallery");
const savedGallery = JSON.parse(localStorage.getItem("gallery") || "[]");

savedGallery.forEach((item, index) => {
  const box = document.createElement("div");
  box.classList.add("preview-box");
  box.innerHTML = `
    <img src="${item.src}" class="blurred" alt="Image ${index+1}">
    <p class="locked-text">$${item.price.toFixed(2)}</p>
    <button onclick="openPayment('${item.src}', ${item.price})" class="buy-btn">Buy Now</button>
  `;
  galleryContainer.appendChild(box);
});

// OPEN PAYMENT POPUP
function openPayment(imgSrc, price) {
  localStorage.setItem("currentItem", JSON.stringify({ imgSrc, price }));
  document.getElementById("paymentModal").style.display = "block";
}

// CLOSE PAYMENT POPUP
function closePayment() {
  document.getElementById("paymentModal").style.display = "none";
}

// CONFIRM PAYMENT
function confirmPayment() {
  const email = document.getElementById("emailInput").value;
  const proofFile = document.getElementById("paymentProof").files[0];

  if(!email.trim()) { alert("Enter your email to receive the download link."); return; }
  if(!proofFile) { alert("Upload payment proof image."); return; }

  const reader = new FileReader();
  reader.onload = () => {
    const currentItem = JSON.parse(localStorage.getItem("currentItem"));
    emailjs.send("service_62yc0zi", "template_ugv2uq9", {
      user_email: email,
      item_price: currentItem.price,
      download_link: currentItem.imgSrc,
      proof_file: reader.result
    })
    .then(() => { alert("Payment confirmed! Download link sent to your email."); closePayment(); })
    .catch(err => { alert("Error sending email. Check console."); console.log(err); });
  };
  reader.readAsDataURL(proofFile);
}